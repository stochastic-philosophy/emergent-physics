<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergent Physics Research</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/themes-light.css" id="theme-css">
    
    <!-- External Libraries (CDN) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/feather-icons/4.29.0/feather.min.js"></script>
    
    <!-- Debug mode indicator -->
    <script>
        window.DEBUG_MODE = localStorage.getItem('debug_mode') === 'true';
        if (window.DEBUG_MODE) {
            document.documentElement.classList.add('debug-mode');
        }
    </script>
</head>
<body>
    <!-- Header Navigation -->
    <header class="main-header">
        <div class="header-container">
            <div class="header-left">
                <h1 class="site-title">
                    <span data-key="site_title">Emergent Physics Research</span>
                </h1>
            </div>
            
            <div class="header-right">
                <!-- Language Switcher -->
                <div class="language-switcher">
                    <button id="lang-fi" class="lang-btn active" data-lang="fi">FI</button>
                    <button id="lang-en" class="lang-btn" data-lang="en">EN</button>
                </div>
                
                <!-- Theme Switcher -->
                <div class="theme-switcher">
                    <button id="theme-toggle" class="theme-btn" title="Toggle theme">
                        <i data-feather="sun" class="theme-icon"></i>
                    </button>
                </div>
                
                <!-- Debug Toggle (only in development) -->
                <div class="debug-toggle" style="display: none;">
                    <button id="debug-toggle" class="debug-btn" title="Toggle debug mode">
                        <i data-feather="bug" class="debug-icon"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="main-content">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <nav class="main-navigation">
                <h2 data-key="nav_projects">Projektit</h2>
                <div id="projects-list" class="projects-list">
                    <!-- Projects will be loaded here dynamically -->
                    <div class="loading">
                        <span data-key="loading">Ladataan...</span>
                    </div>
                </div>
            </nav>
        </aside>

        <!-- Content Area -->
        <section class="content-area">
            <div id="main-content" class="main-content-inner">
                <!-- Welcome screen -->
                <div class="welcome-screen">
                    <h1 data-key="welcome_title">Tervetuloa tutkimusalustalle</h1>
                    <p data-key="welcome_description">
                        Valitse vasemmalta projekti aloittaaksesi tutustumisen tutkimustuloksiin.
                    </p>
                    
                    <!-- Enhanced status indicator with PDF capability info -->
                    <div class="status-indicator">
                        <div class="status-item">
                            <span data-key="status_theme">Teema:</span>
                            <span id="current-theme-display">Vaalea</span>
                        </div>
                        <div class="status-item">
                            <span data-key="status_language">Kieli:</span>
                            <span id="current-language-display">Suomi</span>
                        </div>
                        <div class="status-item">
                            <span data-key="status_pdf">PDF-tuki:</span>
                            <span id="pdf-capability-display">üîÑ Ladataan...</span>
                        </div>
                    </div>
                    
                    <!-- PDF Feature Highlight -->
                    <div class="feature-highlight">
                        <h3>üìÑ Parannettu PDF-generointi</h3>
                        <ul>
                            <li>‚úÖ Kuvien automaattinen lataus ja optimointi</li>
                            <li>‚úÖ Matematiikan t√§ydellinen render√∂inti (MathJax)</li>
                            <li>‚úÖ Syntaksikorostuksen s√§ilytt√§minen</li>
                            <li>‚úÖ Responsiivinen etenemispalkin n√§ytt√∂</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="main-footer">
        <div class="footer-content">
            <p data-key="footer_text">
                &copy; 2025 Emergent Physics Research. 
                <a href="debug.html" target="_blank" data-key="debug_link">Debug Tools</a>
                | <span id="pdf-status-footer">PDF: Ladataan...</span>
            </p>
        </div>
    </footer>

    <!-- Loading Overlay with Enhanced PDF Support Info -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p data-key="loading_content">Ladataan sis√§lt√∂√§...</p>
            <small>Valmistellaan PDF-tukea kuvien ja matematiikan kanssa...</small>
        </div>
    </div>

    <!-- JavaScript Modules (FIXED - Proper Loading Order) -->
    
    <!-- LAYER 1: Core utilities (no dependencies) -->
    <script src="assets/js/debug-logger.js"></script>
    <script src="assets/js/utils.js"></script>
    <script src="assets/js/storage.js"></script>
    
    <!-- LAYER 2: UI and theme management (depends on Layer 1) -->
    <script src="assets/js/ui.js"></script>
    <script src="assets/js/theme-manager.js"></script>
    
    <!-- LAYER 3: File management and content processing (depends on Layer 1-2) -->
    <script src="assets/js/file-manager.js"></script>
    <script src="assets/js/markdown-processor.js"></script>
    
    <!-- LAYER 4: Application modules (depends on Layer 1-3) -->
    <script src="assets/js/project-manager.js"></script>
    <script src="assets/js/navigation-manager.js"></script>
    
    <!-- LAYER 5: FIXED - PDF Support modules with proper error handling -->
    <!-- IMPORTANT: Replace these files with the corrected versions from artifacts -->
    <!-- 1. Replace pdf-library-manager.js with content from "pdf-library-manager-enhanced" -->
    <!-- 2. Replace pdf-generator.js with content from "pdf-generator-bugfixed" -->
    <!-- 3. Replace content-renderer.js with content from "content-renderer-bugfixed" -->
    
    <script src="assets/js/pdf-library-manager.js"></script>
    <script src="assets/js/pdf-generator.js"></script>
    <script src="assets/js/content-renderer.js"></script>
    
    <!-- LAYER 6: Main application orchestration (depends on all layers) -->
    <script src="assets/js/app.js"></script>
    
    <!-- Initialize Feather Icons -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof feather !== 'undefined') {
                feather.replace();
            }
        });
    </script>
    
    <!-- Enhanced PDF System Status Monitoring -->
    <script>
        window.addEventListener('load', function() {
            // Monitor PDF system readiness with error handling
            function updatePDFStatus() {
                try {
                    const footerStatus = document.getElementById('pdf-status-footer');
                    const capabilityDisplay = document.getElementById('pdf-capability-display');
                    
                    if (typeof PDFLibraryManager !== 'undefined' && typeof PDFGenerator !== 'undefined') {
                        const status = PDFLibraryManager.getLibraryStatus();
                        const allReady = status.fullyReady;
                        
                        const statusText = allReady ? 
                            '‚úÖ Valmis (kuvat + matematiikka)' : 
                            'üîÑ Ladataan kirjastoja...';
                        
                        if (footerStatus) footerStatus.textContent = `PDF: ${statusText}`;
                        if (capabilityDisplay) capabilityDisplay.textContent = statusText;
                        
                        if (allReady) {
                            console.log('üéâ Enhanced PDF system fully loaded with image and math support!');
                            return;
                        }
                    } else {
                        // Modules not loaded yet
                        const statusText = '‚è≥ Ladataan moduuleja...';
                        if (footerStatus) footerStatus.textContent = `PDF: ${statusText}`;
                        if (capabilityDisplay) capabilityDisplay.textContent = statusText;
                    }
                    
                    // Retry after delay if not ready
                    setTimeout(updatePDFStatus, 1000);
                } catch (error) {
                    console.error('Error updating PDF status:', error);
                    const footerStatus = document.getElementById('pdf-status-footer');
                    const capabilityDisplay = document.getElementById('pdf-capability-display');
                    
                    const errorText = '‚ùå Virhe PDF-j√§rjestelm√§ss√§';
                    if (footerStatus) footerStatus.textContent = `PDF: ${errorText}`;
                    if (capabilityDisplay) capabilityDisplay.textContent = errorText;
                }
            }
            
            // Start monitoring after a short delay
            setTimeout(updatePDFStatus, 500);
        });
        
        // Enhanced debugging for PDF issues with error handling
        if (window.DEBUG_MODE) {
            window.addEventListener('load', function() {
                console.group('üîß Enhanced PDF System Status (Bug Fixed)');
                
                try {
                    console.log('App Info:', window.App ? App.getInfo() : 'Not loaded');
                    console.log('Module Status:', window.App ? App.getModuleStatus() : 'Not available');
                    console.log('ContentRenderer (Bug Fixed):', typeof ContentRenderer !== 'undefined' ? '‚úÖ Loaded' : '‚ùå Missing');
                    console.log('PDFGenerator (Bug Fixed):', typeof PDFGenerator !== 'undefined' ? '‚úÖ Loaded' : '‚ùå Missing');
                    console.log('PDFLibraryManager (Enhanced):', typeof PDFLibraryManager !== 'undefined' ? '‚úÖ Loaded' : '‚ùå Missing');
                    
                    // Test PDF module integration with enhanced features
                    if (typeof PDFGenerator !== 'undefined' && typeof PDFLibraryManager !== 'undefined') {
                        console.log('PDF Module Integration: ‚úÖ Ready with Bug Fixes');
                        console.log('üîß Bug Fixes Applied:');
                        console.log('  - ‚úÖ Fixed global function access issues');
                        console.log('  - ‚úÖ Fixed container cleanup memory leaks');
                        console.log('  - ‚úÖ Fixed async/await error handling');
                        console.log('  - ‚úÖ Fixed image loading timeout handling');
                        console.log('  - ‚úÖ Fixed MathJax synchronization');
                        console.log('  - ‚úÖ Fixed PDF button state management');
                        
                        // Test library status after delay with error handling
                        setTimeout(() => {
                            try {
                                console.log('üìä PDF Libraries Status:', PDFLibraryManager.getLibraryStatus());
                                console.log('üß™ Library Tests:', PDFLibraryManager.testLibraries());
                                console.log('üìã Generator Status:', PDFGenerator.getStatus());
                                
                                if (typeof ContentRenderer !== 'undefined') {
                                    console.log('üìÑ Content Readiness:', ContentRenderer.getContentReadiness());
                                }
                            } catch (error) {
                                console.error('Error in PDF status check:', error);
                            }
                        }, 2000);
                    } else {
                        console.log('PDF Module Integration: ‚ùå Not Ready');
                    }
                    
                } catch (error) {
                    console.error('Error in debug information gathering:', error);
                }
                
                console.groupEnd();
                
                // Test content monitoring with error handling
                try {
                    if (typeof ContentRenderer !== 'undefined') {
                        console.log('üéØ Content monitoring system active (bug fixed)');
                        console.log('üìã Features: Image load detection, MathJax sync, PDF readiness, global function access');
                    }
                } catch (error) {
                    console.error('Error in content monitoring test:', error);
                }
            });
        }
        
        // Global error handler for PDF-related issues
        window.addEventListener('error', function(e) {
            if (e.error && e.error.message && 
                (e.error.message.includes('PDF') || 
                 e.error.message.includes('ContentRenderer') || 
                 e.error.message.includes('html2pdf'))) {
                console.error('PDF-related error detected:', e.error);
                
                // Try to show user-friendly error
                if (typeof UI !== 'undefined' && UI.showNotification) {
                    UI.showNotification('PDF system error. Please refresh the page.', 'error', 5000);
                }
            }
        });
    </script>
    
    <!-- Enhanced Styles for PDF Features -->
    <style>
        /* Enhanced welcome screen styles */
        .feature-highlight {
            margin-top: 2rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(16, 185, 129, 0.1));
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        .feature-highlight h3 {
            margin: 0 0 1rem 0;
            color: #1f2937;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .feature-highlight ul {
            margin: 0;
            padding-left: 1.5rem;
            list-style: none;
        }
        
        .feature-highlight li {
            margin-bottom: 0.5rem;
            color: #374151;
            font-size: 0.95rem;
            line-height: 1.4;
        }
        
        /* Enhanced loading overlay */
        .loading-overlay small {
            display: block;
            margin-top: 0.5rem;
            opacity: 0.8;
            font-size: 0.8rem;
            color: #6b7280;
        }
        
        /* Status indicator enhancements */
        .status-indicator {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
            padding: 1.5rem;
            background: rgba(243, 244, 246, 0.5);
            border-radius: 8px;
        }
        
        .status-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .status-item span:first-child {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }
        
        .status-item span:last-child {
            font-weight: 600;
            color: #374151;
        }
        
        /* Error state styling */
        .status-item span[id*="pdf"]:before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
            background: #6b7280;
        }
        
        /* PDF ready state */
        .status-item span:contains("‚úÖ"):before,
        .status-item span[id*="pdf"]:contains("Valmis"):before {
            background: #10b981 !important;
        }
        
        /* PDF error state */
        .status-item span:contains("‚ùå"):before,
        .status-item span[id*="pdf"]:contains("Virhe"):before {
            background: #ef4444 !important;
        }
        
        /* PDF loading state */
        .status-item span:contains("üîÑ"):before,
        .status-item span[id*="pdf"]:contains("Ladataan"):before {
            background: #f59e0b !important;
            animation: pulse 1.5s ease-in-out infinite alternate;
        }
        
        @keyframes pulse {
            from { opacity: 1; }
            to { opacity: 0.5; }
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .status-indicator {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            
            .feature-highlight {
                padding: 1rem;
            }
            
            .feature-highlight li {
                font-size: 0.875rem;
            }
        }
        
        /* Dark theme support for new elements */
        @media (prefers-color-scheme: dark) {
            .feature-highlight {
                background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(16, 185, 129, 0.15));
                border-color: rgba(59, 130, 246, 0.3);
            }
            
            .feature-highlight h3 {
                color: #f3f4f6;
            }
            
            .feature-highlight li {
                color: #d1d5db;
            }
            
            .status-indicator {
                background: rgba(55, 65, 81, 0.5);
            }
            
            .status-item span:first-child {
                color: #9ca3af;
            }
            
            .status-item span:last-child {
                color: #f3f4f6;
            }
        }
    </style>
</body>
</html>
